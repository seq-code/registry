<%= pager(@names) %>

<div class="text-center mb-4 w-100">
  <%= link_to('#', class: 'btn btn-primary', id: 'smart-checks') do %>
    <%= fa_icon('robot') %> Smart-check easy cases
  <% end %>
</div>

<table class="table table-hover table-responsive">
  <thead>
    <tr>
      <th>Name, Type</th>
      <th>Checks</th>
      <th>RDP Classification</th>
      <th>MiGA Classification</th>
    </tr>
  </thead>
  <tbody>
    <% @names.each do |name| %>
      <% genome = name.type_genome %>
      <tr>
        <td><%= display_link(name) %>, <%= display_link(genome) %></td>
        <td class="curator-checklist">
          <% @checks[@check].each do |check_type| %>
            <% warn = name.qc_warnings[check_type] or next %>
            <%= render(
                  partial: 'checks/curator',
                  locals: { warn: warn, no_message: true, no_section: true }
                ) %>
          <% end %>
        </td>
        <td rowspan=2>
          <% rdp_file =
              genome&.miga_object&.result(:ssu)&.file_path(:classification) %>
          <% if rdp_file %>
            <% Zlib::GzipReader.open(rdp_file) do |fh| %>
              <% fh.each do |ln| %>
                <% next if ln =~ /^#/ %>
                <% row = ln.chomp.split("\t") %>
                <b><%= row.shift %></b>
                <ul>
                  <% row.shift %>
                  <% while (tax = row.shift(3)).any? %>
                    <% break if tax[2].to_f < 0.5 %>
                    <li>
                      <%= show_tax_string(
                            tax[1] + ':' + tax[0], id: "tax-#{name.id}-16s"
                          ) %>
                      <span class="text-muted">(<%= tax[2] %>)</span>
                    </li>
                  <% end %>
                </ul>
              <% end %>
            <% end %>
          <% end %>
        </td>
        <td rowspan=2>
          <% miga_classif = genome&.miga_object&.metadata&.[](:tax) %>
          <%= show_tax_string(miga_classif, id: "tax-#{name.id}-miga") %>
        </td>
      </tr>
      <tr>
        <td colspan=2>
          <b>Reported Classification</b><br/>
          <%= show_tax_string(
                name.lineage.map { |i| "#{i.inferred_rank}:#{i.name}" },
                id: "tax-#{name.id}-reported"
              ) %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>
<%= render(partial: 'checks/curator_script') %>
<%= pager(@names) %>

<script>
  function auto_check_name(name_id) {
    if (!name_id) return false;

    // Check if the MiGA classification matches the 16S one
    var success = true;
    var miga = $(`#tax-${name_id}-miga [data-kind=taxonomy]`).last();
    var copies = $(`ul:has(#tax-${name_id}-16s)`);
    copies.each(function() {
      var ul = $(this);
      var expected = ul.find(
        `#tax-${name_id}-16s ` +
          `[data-kind=taxonomy][data-rank="${miga.data("rank")}"]` +
          `[data-value="${miga.data("value")}"]`
      );
      if (expected.length == 0) {
        success = false;
        miga.parents("td").addClass("bg-warning");
        ul.addClass("bg-warning");
      }
    });
    if (!success) return false;

    // If all is good, auto-check the button, but only if it's currently
    // in "skip" status (i.e., not yet passed or failed)
    $(`.check-skip .check-links [data-name=${name_id}][data-do=pass]`).click();
    return true;
  }

  $("#smart-checks").on("click", function() {
    var passed = 0;
    var all = $(".curator-checklist .check-skip").each(function() {
      var skip = $(this);
      var name_id = skip.find("a[data-do=skip]").data("name");
      if (auto_check_name(name_id)) passed += 1;
    }).length;
    alert(`Auto-passed ${passed} names of ${all} checked`);
    return false;
  });
</script>

